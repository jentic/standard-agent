compose: |
  <role>
  You are an expert workflow composer. Using only the structured context below,
  produce a portable, vendor-neutral Arazzo 1.0.1 workflow YAML that captures the
  successful agent workflow. Do not include any auth fields.
  </role>

  <structured_context>
  Goal: {goal_text}
  Tools: {tools_json}
  GeneratedParams: {params_json}
  Executions: {executions_json}
  PlanSteps (optional): {plan_steps_json}
  </structured_context>

  <hard_rules>
  - Auth is out of scope; do not include any auth fields.
  - sourceDescriptions: for each unique Tools[i].api_name create an entry:
      name: safe slug of api_name (non-alphanumerics → '-')
      url: jentic/oak/{{api_name}}
      type: openapi
  - Steps MUST follow Executions order exactly; one step per execution.
  - operationPath for a step: Tools[tool_id].path (verbatim).
  - Parameters for a step: INTERSECTION of GeneratedParams[tool_id].keys and
    Tools[tool_id].parameters.allowed/required (when available).
  - Path templated params: if operationPath contains '{{param}}', map it with in: path.
  - Remaining params: prefer in: query for typical filters (e.g., q, begin_date, end_date, sort, limit, page);
    otherwise place under requestBody.payload.
  - Chaining: when a param value can be sourced from a prior step's outputs, you MUST replace
    $inputs.<param> with $steps.<prevStepId>.outputs.<key>.
  - Outputs per step: expose at least one meaningful value with $response.body#/… (prefer ids; else top-level
    business fields; final fallback: result: $response.body#/).
  - Workflow inputs: the union of parameters still referencing $inputs.* after chaining; do not include values
    produced by prior steps.
  - Workflow outputs: one concise, goal-aligned value (e.g., final id/status/count).
  </hard_rules>

  <construction_plan>
  1) Build sourceDescriptions from Tools (api_name → url jentic/oak/{{api_name}}).
  2) For each Execution in order:
     - Resolve tool metadata (path, parameters.allowed/required) by tool_id.
     - Compute candidate params via intersection of GeneratedParams and parameters.allowed/required.
     - Initialize param values to $inputs.<param>.
     - If PlanSteps exists, use its input_keys to suggest chaining; otherwise, chain from prior outputs when semantically aligned
       (ids/docs/text), replacing $inputs.<param> with $steps.<prevId>.outputs.<key>.
     - Add successCriteria: $statusCode == 200.
     - Add outputs with JSON pointers (ids preferred).
  3) Compute workflow inputs (remaining $inputs.*) and a sensible workflow output based on Goal.
  </construction_plan>

  <requirements>
  - Output MUST be valid Arazzo 1.0.1 YAML.
  - Keep stepIds concise (kebab-case) and output keys snake_case.
  - No extra text or fences; YAML only.
  </requirements>

  <output>
  Return ONLY the Arazzo YAML, no fences, no extra prose.
  </output>


